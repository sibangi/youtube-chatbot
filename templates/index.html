<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Video Q&A</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.10.3/cdn.min.js" defer></script>
</head>
<body class="bg-light">
<div class="container py-5" x-data="{
        isVideoLoading: false,
        isVideoLoaded: false,
        isQuestionLoading: false,
        answer: '',
        isQuestionAsked: false,
        formValid: false,
        streamingAnswer: false,
        checkFormValidity() {
            this.formValid = document.getElementById('first_name').value.trim() !== '' &&
                             document.getElementById('last_name').value.trim() !== '' &&
                             document.getElementById('work_status').value !== '' &&
                             document.getElementById('gender').value !== '' &&
                             document.getElementById('youtube_url').value.trim() !== '';
        },
        async loadVideo() {
            if (this.isVideoLoaded) return;
            this.isVideoLoading = true;
            // Simulating video loading
            await new Promise(resolve => setTimeout(resolve, 2000));
            this.isVideoLoading = false;
            this.isVideoLoaded = true;
        },
        async askQuestion() {
            if (!this.formValid || !this.isVideoLoaded) return;
            
            this.isQuestionLoading = true;
            this.streamingAnswer = true;
            this.answer = '';

            const eventSource = new EventSource('/ask_stream?' + new URLSearchParams({
                youtube_url: document.getElementById('youtube_url').value,
                question: document.getElementById('question').value,
                first_name: document.getElementById('first_name').value,
                last_name: document.getElementById('last_name').value,
                work_status: document.getElementById('work_status').value,
                gender: document.getElementById('gender').value
            }));

            eventSource.onmessage = (event) => {
                if (event.data === '[DONE]') {
                    eventSource.close();
                    this.isQuestionLoading = false;
                    this.streamingAnswer = false;
                    this.isQuestionAsked = true;
                } else {
                    this.answer += event.data;
                }
            };

            eventSource.onerror = (error) => {
                console.error('EventSource failed:', error);
                eventSource.close();
                this.isQuestionLoading = false;
                this.streamingAnswer = false;
                this.isQuestionAsked = true;
            };
        },
        async submitFeedback(type) {
            const response = await fetch('/feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    feedback: type,
                    question: document.getElementById('question').value,
                    answer: this.answer
                })
            });
            const result = await response.json();
            if (result.message) {
                alert('Thank you for your feedback!');
                this.isQuestionAsked = false;
                this.answer = '';
                document.getElementById('question').value = '';
            }
        },
        async resetCSV() {
            if (confirm('Are you sure you want to reset the CSV file? This action cannot be undone.')) {
                const response = await fetch('/reset_csv', { method: 'POST' });
                const result = await response.json();
                if (result.message) {
                    alert(result.message);
                } else if (result.error) {
                    alert('Error: ' + result.error);
                }
            }
        }
    }" x-init="checkFormValidity">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-body">
                    <h1 class="card-title text-center mb-4">YouTube Video Q&A</h1>

                    <form @change="checkFormValidity">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="first_name" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="first_name" placeholder="First Name"
                                       required>
                            </div>
                            <div class="col-md-6">
                                <label for="last_name" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="last_name" placeholder="Last Name" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="work_status" class="form-label">Work Status</label>
                            <select class="form-select" id="work_status" required>
                                <option value="">Select...</option>
                                <option value="Student">Student</option>
                                <option value="Staff">Staff</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="gender" class="form-label">Gender</label>
                            <select class="form-select" id="gender" required>
                                <option value="">Select...</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="youtube_url" class="form-label">YouTube URL</label>
                            <input type="text" class="form-control" id="youtube_url"
                                   placeholder="https://www.youtube.com/watch?v=..." required
                                   @input="isVideoLoaded = false">
                        </div>

                        <div class="mb-3">
                            <button type="button" class="btn"
                                    x-bind:class="{
                                        'btn-danger': !formValid && !isVideoLoaded,
                                        'btn-success': formValid && !isVideoLoaded,
                                        'btn-secondary': isVideoLoaded
                                    }"
                                    x-on:click="loadVideo()"
                                    x-bind:disabled="!formValid || isVideoLoading || isVideoLoaded">
                                    <span x-show="!isVideoLoading && !isVideoLoaded">
                                        <i class="bi bi-play-circle me-2"></i>Load Video
                                    </span>
                                <span x-show="isVideoLoading">
                                        <i class="bi bi-hourglass-split me-2"></i>Loading Video...
                                    </span>
                                <span x-show="isVideoLoaded">
                                        <i class="bi bi-check-circle me-2"></i>Video Loaded
                                    </span>
                            </button>
                        </div>

                        <div class="mb-3">
                            <label for="question" class="form-label">Question</label>
                            <textarea class="form-control" id="question" rows="3"
                                      placeholder="Ask me something about this video"
                                      x-bind:disabled="isQuestionAsked || !isVideoLoaded"></textarea>
                        </div>

                        <div class="d-grid">
                            <button type="button" class="btn btn-primary" x-on:click="askQuestion()"
                                    x-bind:disabled="!formValid || isQuestionLoading || isQuestionAsked || !isVideoLoaded">
                                    <span x-show="!isQuestionLoading">
                                        <i class="bi bi-question-circle me-2"></i>Ask Question
                                    </span>
                                <span x-show="isQuestionLoading">
                                        <i class="bi bi-hourglass-split me-2"></i>Processing Question...
                                    </span>
                            </button>
                        </div>
                    </form>

                    <div class="mt-4" x-show="answer || streamingAnswer">
                        <h5 class="card-title">Answer:</h5>
                        <p class="card-text bg-light p-3 rounded" x-text="answer"></p>
                        <div x-show="streamingAnswer" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3" x-show="!streamingAnswer && answer">
                        <h5 class="mb-2">Was this answer helpful?</h5>
                        <button class="btn btn-outline-success me-2" @click="submitFeedback('positive')">
                            <i class="bi bi-hand-thumbs-up"></i> Yes
                        </button>
                        <button class="btn btn-outline-danger" @click="submitFeedback('negative')">
                            <i class="bi bi-hand-thumbs-down"></i> No
                        </button>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <a href="{{ url_for('download_csv') }}" class="btn btn-success me-2">
                    <i class="bi bi-download me-2"></i>Download CSV
                </a>
                <button @click="resetCSV" class="btn btn-danger">
                    <i class="bi bi-trash me-2"></i>Reset CSV
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS and Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
</body>
</html>