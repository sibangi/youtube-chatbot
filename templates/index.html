<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Q&A</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto py-5" x-data="{
        isVideoLoading: false,
        isVideoLoaded: false,
        isQuestionLoading: false,
        answer: '',
        isQuestionAsked: false,
        formValid: false,
        streamingAnswer: false,
        feedbackProvided: true,
        checkFormValidity() {
            this.formValid = document.getElementById('participant_id').value.trim() !== '' &&
                             document.getElementById('work_status').value !== '' &&
                             document.getElementById('gender').value !== '' &&
                             document.getElementById('youtube_url').value.trim() !== '';
        },
        async loadVideo() {
            if (this.isVideoLoaded) return;
            this.isVideoLoading = true;
            // Simulating video loading
            await new Promise(resolve => setTimeout(resolve, 2000));
            this.isVideoLoading = false;
            this.isVideoLoaded = true;
        },
        async askQuestion() {
            if (!this.formValid || !this.isVideoLoaded || !this.feedbackProvided) return;

            this.isQuestionLoading = true;
            this.streamingAnswer = true;
            this.answer = '';
            this.feedbackProvided = false;

            const eventSource = new EventSource('/ask_stream?' + new URLSearchParams({
                youtube_url: document.getElementById('youtube_url').value,
                question: document.getElementById('question').value,
                participant_id: document.getElementById('participant_id').value,
                work_status: document.getElementById('work_status').value,
                gender: document.getElementById('gender').value
            }));

            eventSource.onmessage = (event) => {
                if (event.data === '[DONE]') {
                    eventSource.close();
                    this.isQuestionLoading = false;
                    this.streamingAnswer = false;
                    this.isQuestionAsked = true;
                } else {
                    this.answer += event.data;
                }
            };

            eventSource.onerror = (error) => {
                console.error('EventSource failed:', error);
                eventSource.close();
                this.isQuestionLoading = false;
                this.streamingAnswer = false;
                this.isQuestionAsked = true;
            };
        },
        async submitFeedback(type) {
            const response = await fetch('/feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    feedback: type,
                    question: document.getElementById('question').value,
                    answer: this.answer
                })
            });
            const result = await response.json();
            if (result.message) {
                alert('Thank you for your feedback!');
                this.isQuestionAsked = false;
                this.answer = '';
                document.getElementById('question').value = '';
                this.feedbackProvided = true;
            }
        }
    }" x-init="checkFormValidity">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
                    <h1 class="text-2xl font-bold text-center mb-4">Video Q&A</h1>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="participant_id">
                            Participant ID
                        </label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="participant_id" type="text" placeholder="Enter Participant ID" @input="checkFormValidity()">
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="work_status">
                            Work Status
                        </label>
                        <select class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="work_status" @change="checkFormValidity()">
                            <option value="">Select...</option>
                            <option value="Student">Student</option>
                            <option value="Staff">Staff</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="gender">
                            Gender
                        </label>
                        <select class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="gender" @change="checkFormValidity()">
                            <option value="">Select...</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="youtube_url">
                            YouTube URL
                        </label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="youtube_url" type="text" placeholder="Enter YouTube URL" @input="checkFormValidity()">
                    </div>

                    <div class="mb-4">
                        <button
                            @click="loadVideo"
                            x-show="!isVideoLoading && !isVideoLoaded"
                            :class="{'bg-red-500': !formValid, 'bg-blue-500': formValid, 'hover:bg-blue-700': formValid}"
                            class="w-full text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                            :disabled="!formValid">
                            Load Video
                        </button>
                        <button
                            x-show="isVideoLoading"
                            class="w-full bg-yellow-500 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                            disabled>
                            Loading Video...
                        </button>
                        <button
                            x-show="isVideoLoaded"
                            class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                            disabled>
                            Video Loaded
                        </button>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="question">
                            Question
                        </label>
                        <textarea
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            id="question"
                            placeholder="Enter your question"
                            :disabled="!feedbackProvided && isQuestionAsked"
                        ></textarea>
                    </div>

                    <div class="mb-4">
                        <button
                            @click="askQuestion"
                            x-show="!isQuestionLoading"
                            :class="{'bg-red-500': !isVideoLoaded || !feedbackProvided, 'bg-green-500': isVideoLoaded && feedbackProvided, 'hover:bg-green-700': isVideoLoaded && feedbackProvided}"
                            class="w-full text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                            :disabled="!isVideoLoaded || !feedbackProvided">
                            Ask Question
                        </button>
                        <button
                            x-show="isQuestionLoading"
                            class="w-full bg-yellow-500 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                            disabled>
                            Processing Question...
                        </button>
                    </div>

                    <div class="mt-4" x-show="answer || streamingAnswer">
                        <h5 class="font-bold mb-2">Answer:</h5>
                        <p x-text="answer"></p>
                        <div class="text-center" x-show="streamingAnswer">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3" x-show="!streamingAnswer && answer">
                        <h5 class="font-bold mb-2">Was this answer helpful?</h5>
                        <div class="flex justify-center space-x-4">
                            <button @click="submitFeedback('positive')" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                                <i class="fas fa-thumbs-up mr-2"></i> Yes
                            </button>
                            <button @click="submitFeedback('negative')" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                                <i class="fas fa-thumbs-down mr-2"></i> No
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>